var fs = require('fs'),
    querystring = require('querystring'),
    newPost = {};

exports.sendPostingsAction = function(req, res){
    var postData = '';
    req.addListener('data', function(postDataChunk){
        postData += postDataChunk;
    });

    req.addListener('end', function(){
        var paramStr = require('url').parse(req.url).query;
        var paramObj = querystring.parse(paramStr);
        var username = paramObj['username'];

        var message = querystring.parse(postData);

        var userStr = fs.readFileSync(BASE_DIR + '/data/user.json');
        var users = JSON.parse(userStr);
        var postingsStr = fs.readFileSync(BASE_DIR + '/data/postings.json');
        var postings = JSON.parse(postingsStr);

        var mark = false,
            index;

        /*newPost.name = 'post' + (postings.postings.length + 1);
        newPost.belong = username;
        newPost.comments = message['comments'] ? message['comments'] : '';
        newPost.category = message['category'] ? message['category'] : 'others';
        newPost.title = message['title'] ? message['title'] : '';
        newPost.content = message['content'] ? message['content'] : '';
        newPost.good = message['good'] ? message['good'] : 0;
        newPost.bad = message['bad'] ? message['bad'] : 0;
        newPost.picture = message['picture'] ? message['picture'] : '';

        console.log(newPost);

        postings.postings.push(newPost);*/

        for(var i in users.users){
            if(users.users[i].name == username){
                //users.users[i].postingsSend.push(newPost.name);
                index = i;
                mark = true;
                break;
            }
        }

        if(!mark){
            console.log("can not find this username!");
            res.writeHead(200, {'Content-Type' : 'text/plain'});
            res.write("can not find this username!");
            res.end();

            return;
        }else{

            newPost.name = 'post' + (postings.postings.length + 1);
            newPost.belong = username;
            newPost.comments = message['comments'] ? message['comments'] : '';
            newPost.category = message['category'] ? message['category'] : 'others';
            newPost.title = message['title'] ? message['title'] : '';
            newPost.content = message['content'] ? message['content'] : '';
            newPost.good = message['good'] ? message['good'] : 0;
            newPost.bad = message['bad'] ? message['bad'] : 0;
            newPost.picture = message['picture'] ? message['picture'] : '';

            console.log(newPost);

            postings.postings.push(newPost);

            users.users[index].postingsSend.push(newPost.name);

            fs.writeFile(BASE_DIR + '/data/user.json', JSON.stringify(users), function(err){
                if(err){
                    console.log(err);
                }else{
                    console.log("user.json was modified!");
                }
            });

            fs.writeFile(BASE_DIR + '/data/postings.json', JSON.stringify(postings), function(err){
                if(err){
                    console.log(err);
                }else{
                    console.log("postings.json was modified!");
                }
            });
        }

        res.writeHead(200, {'Content-Type' : 'text/plain'});
        res.write("send post success!");
        res.end();

        console.log("send post success!");
    });
};