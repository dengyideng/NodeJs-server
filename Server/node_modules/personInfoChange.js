var fs = require('fs'),
    querystring = require('querystring'),
    url = require('url');
    changeUser = {},
    theUser =  {};

exports.personInfoChange = function(req, res){
    var postData = '';
    req.addListener('data', function(postDataChunk){
        postData += postDataChunk;
    });

    req.addListener('end', function(){

        var paramStr = url.parse(req.url).query;
        var paramObj = querystring.parse(paramStr);

        var username = paramObj['username'];
        var password = paramObj['password'];

        var message = querystring.parse(postData);
        var userStr = fs.readFileSync(BASE_DIR + '/database/user.json');
        var users = JSON.parse(userStr);


        for(var i in users.users){
            if(users.users[i].name == username && users.users[i].password == password){
                theUser = users.users[i];

                changeUser.name = message['name'] ? message['name'] : theUser['name'];
                changeUser.age = message['age'] ? message['age'] : theUser['age'];
                changeUser.sex = message['sex'] ? message['sex'] : theUser['sex'];
                changeUser.qq = message['qq'] ? message['qq'] : theUser['qq'];
                changeUser.tel = message['tel'] ? message['tel'] : theUser['tel'];
                changeUser.password = message['password'] ? message['password'] : theUser['password'];
                changeUser.postingsSend = message['postingsSend'] ? message['postingsSend'] : theUser['postingsSend'];
                changeUser.postingsComment = message['postingsComment'] ? message['postingsComment'] : theUser['postingsComment'];
                changeUser.postingsCollect = message['postingsCollect'] ? message['postingsCollect'] : theUser['postingsCollect'];
                changeUser.postingsBrowsede = message['postingsBrowsed'] ? message['postingsBrowsed'] : theUser['postingsBrowsed'];

                users.users.splice(i, 1);
                users.users.push(changeUser);

                console.log(users);

                fs.writeFile(BASE_DIR + '/database/user.json', JSON.stringify(users), function(err){
                    if(err){
                        console.log(err);
                    }else{
                        console.log("user message has already changed!");
                    }
                });

                res.writeHead(200, {'Content-Type' : 'text/plain'});
                res.write("this user message has already changed!");
                res.end();
                console.log("this user message has already changed!");

                return;
            }
        }

        res.writeHead(200, {'Content-Type' : 'text/plain'});
        res.write("username or password error!");
        res.end();
        console.log("username or password error!");
    });
};